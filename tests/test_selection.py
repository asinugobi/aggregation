from __future__ import print_function
from builtins import range

import numpy as np
import tensorflow as tf

from selection_layer.selection import selection
from selection_layer.selection import tf_selection
from selection_layer.selection import tf_select_max
from cs231n.gradient_check import eval_numerical_gradient_array, eval_numerical_gradient


# array([[[[-0.3       , -0.29263158, -0.28526316, -0.27789474],
#          [-0.27052632, -0.26315789, -0.25578947, -0.24842105],
#          [-0.24105263, -0.23368421, -0.22631579, -0.21894737],
#          [-0.21157895, -0.20421053, -0.19684211, -0.18947368]],

#         [[-0.18210526, -0.17473684, -0.16736842, -0.16      ],
#          [-0.15263158, -0.14526316, -0.13789474, -0.13052632],
#          [-0.12315789, -0.11578947, -0.10842105, -0.10105263],
#          [-0.09368421, -0.08631579, -0.07894737, -0.07157895]],

#         [[-0.06421053, -0.05684211, -0.04947368, -0.04210526],
#          [-0.03473684, -0.02736842, -0.02      , -0.01263158],
#          [-0.00526316,  0.00210526,  0.00947368,  0.01684211],
#          [ 0.02421053,  0.03157895,  0.03894737,  0.04631579]]],


#        [[[ 0.05368421,  0.06105263,  0.06842105,  0.07578947],
#          [ 0.08315789,  0.09052632,  0.09789474,  0.10526316],
#          [ 0.11263158,  0.12      ,  0.12736842,  0.13473684],
#          [ 0.14210526,  0.14947368,  0.15684211,  0.16421053]],

#         [[ 0.17157895,  0.17894737,  0.18631579,  0.19368421],
#          [ 0.20105263,  0.20842105,  0.21578947,  0.22315789],
#          [ 0.23052632,  0.23789474,  0.24526316,  0.25263158],
#          [ 0.26      ,  0.26736842,  0.27473684,  0.28210526]],

#         [[ 0.28947368,  0.29684211,  0.30421053,  0.31157895],
#          [ 0.31894737,  0.32631579,  0.33368421,  0.34105263],
#          [ 0.34842105,  0.35578947,  0.36315789,  0.37052632],
#          [ 0.37789474,  0.38526316,  0.39263158,  0.4       ]]]])


def test_tf_selection():
    x_shape = (2, 3, 4, 4)
    x_size = np.prod(x_shape)
    x = tf.reshape( tf.linspace(-0.3, 0.4, x_size), x_shape )
    out = tf_selection(x)
    
    correct_out = tf.constant([[[[-0.3       , -0.29263158, -0.28526316, -0.27789474],
                              [-0.27052632, -0.26315789, -0.25578947, -0.24842105],
                              [-0.24105263, -0.23368421, -0.22631579, -0.21894737],
                              [-0.21157895, -0.20421053, -0.19684211, -0.18947368]],
                             
                             [[0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ]],
                             
                             [[0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ]]],
                            
                            
                            [[[0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ]],
                             
                             [[0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ]],
                             
                             [[ 0.28947368,  0.29684211,  0.30421053,  0.31157895],
                              [ 0.31894737,  0.32631579,  0.33368421,  0.34105263],
                              [ 0.34842105,  0.35578947,  0.36315789,  0.37052632],
                              [ 0.37789474,  0.38526316,  0.39263158,  0.4       ]]]])


    with tf.Session() as sess:
        c, selection_out = sess.run([correct_out, out])

    assert np.allclose(c, selection_out)
        

def test_selection():
    x_shape = (2, 3, 4, 4)
    x_size = np.prod(x_shape)
    x = np.reshape( np.linspace(-0.3, 0.4, x_size), x_shape )
    out = selection(x)
    
    correct_out = np.array([[[[-0.3       , -0.29263158, -0.28526316, -0.27789474],
                              [-0.27052632, -0.26315789, -0.25578947, -0.24842105],
                              [-0.24105263, -0.23368421, -0.22631579, -0.21894737],
                              [-0.21157895, -0.20421053, -0.19684211, -0.18947368]],
                             
                             [[0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ]],
                             
                             [[0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ]]],
                            
                            
                            [[[0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ]],
                             
                             [[0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ],
                              [0          ,  0         ,  0         ,  0         ]],
                             
                             [[ 0.28947368,  0.29684211,  0.30421053,  0.31157895],
                              [ 0.31894737,  0.32631579,  0.33368421,  0.34105263],
                              [ 0.34842105,  0.35578947,  0.36315789,  0.37052632],
                              [ 0.37789474,  0.38526316,  0.39263158,  0.4       ]]]])
    
    print(out,correct_out)
    assert np.allclose(out, correct_out)


    
def test_tf_select_max():
    x_shape = (2, 3, 4, 4)
    x_size = np.prod(x_shape)
    x = tf.reshape( tf.linspace(-0.3, 0.4, x_size), x_shape )
    out = tf_select_max(x)
    
    correct_out = tf.constant([[[[0          ,  0         ,  0         ,  0         ],
                                 [0          ,  0         ,  0         ,  0         ],
                                 [0          ,  0         ,  0         ,  0         ],
                                 [0          ,  0         ,  0         ,  0         ]],
                                
                                [[0          ,  0         ,  0         ,  0         ],
                                 [0          ,  0         ,  0         ,  0         ],
                                 [0          ,  0         ,  0         ,  0         ],
                                 [0          ,  0         ,  0         ,  0         ]],
                                
                                [[-0.06421053, -0.05684211, -0.04947368, -0.04210526],
                                 [-0.03473684, -0.02736842, -0.02      , -0.01263158],
                                 [-0.00526316,  0.00210526,  0.00947368,  0.01684211],
                                 [ 0.02421053,  0.03157895,  0.03894737,  0.04631579]]],
                               
                               
                               [[[0          ,  0         ,  0         ,  0         ],
                                 [0          ,  0         ,  0         ,  0         ],
                                 [0          ,  0         ,  0         ,  0         ],
                                 [0          ,  0         ,  0         ,  0         ]],
                                
                                [[0          ,  0         ,  0         ,  0         ],
                                 [0          ,  0         ,  0         ,  0         ],
                                 [0          ,  0         ,  0         ,  0         ],
                                 [0          ,  0         ,  0         ,  0         ]],
                                
                                [[ 0.28947368,  0.29684211,  0.30421053,  0.31157895],
                                 [ 0.31894737,  0.32631579,  0.33368421,  0.34105263],
                                 [ 0.34842105,  0.35578947,  0.36315789,  0.37052632],
                                 [ 0.37789474,  0.38526316,  0.39263158,  0.4       ]]]])
    
    
    with tf.Session() as sess:
        c, selection_out = sess.run([correct_out, out])
        print(c, selection_out)

    assert np.allclose(c, selection_out)
